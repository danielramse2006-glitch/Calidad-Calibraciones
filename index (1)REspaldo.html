<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"><title>Inventario - Panel Principal</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .cart-box { background: #fff; color: #333; padding: 12px; border-radius: 6px; margin-top: 15px; border: 1px solid #ccc; display: none; }
        .btn-add-item { background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-weight: bold; }
        .btn-logout { background: #c0392b !important; color: white !important; margin-top: auto; }
        
        /* Estilos del Visor de Imagen */
        #image-preview-container {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ccc;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #main-preview-img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 5px;
            margin-top: 10px;
            border: 1px solid #ddd;
        }

        /* Estilos de impresi√≥n del Vale */
        #print-vale { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-vale, #print-vale * { visibility: visible; }
            #print-vale { display: block; position: absolute; left: 0; top: 0; width: 100%; padding: 40px; color: black; }
            .vale-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
            .vale-table th, .vale-table td { border: 1px solid #000; padding: 8px; text-align: left; }
            .pzas-col { background: #eee !important; font-weight: bold; text-align: center; width: 80px; }
        }
    </style>
</head>
<body class="bg-blue">
    <header><h1>Control de Inventario</h1></header>
    
    <div class="main-container">
        <nav class="side-menu">
            <button id="navReg" style="display:none;" onclick="location.href='registro.html'">Registrar</button>
            <button id="navAct" style="display:none;" onclick="location.href='actualizar.html'">Actualizar</button>
            <button id="navEli" style="display:none;" onclick="location.href='eliminar.html'">Eliminar</button>
            <button id="navAdm" style="display:none; background:#f1c40f;" onclick="location.href='usuarios.html'">Usuarios</button>
            
            <div id="cart-box" class="cart-box">
                <h4 style="margin:0; text-align:center;">üìã VALE DE SALIDA</h4>
                <div id="cart-list" style="margin: 10px 0; font-size: 0.9em;"><i>Vac√≠o</i></div>
                <input type="text" id="recep" placeholder="¬øQui√©n recibe?" style="width:90%; margin-bottom:5px;">
                <input type="text" id="proyec" placeholder="Proyecto/Orden" style="width:90%;">
                <button onclick="procesarSalida()" style="width:100%; background:#e67e22; color:white; border:none; padding:10px; margin-top:10px; font-weight:bold; cursor:pointer; border-radius:4px;">GENERAR VALE</button>
            </div>

            <div id="image-preview-container">
                <p id="preview-title" style="margin:0; font-size: 0.85em; color: #666; font-weight: bold;">Previsualizaci√≥n</p>
                <img id="main-preview-img" src="imagenes/sin_foto.jpg" alt="Vista previa">
            </div>

            <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
        </nav>

        <section class="content">
            <input type="text" id="mainSearch" placeholder="Buscar por modelo, nombre o no. parte..." style="width:100%; padding:12px; margin-bottom:15px; border-radius:5px; border:none;">
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th id="th-plus" style="display:none;">+</th>
                            <th>Modelo</th><th>No. Parte</th><th>Nombre</th><th>Stock</th><th>Ubicaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-body"></tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="print-vale">
        <h1 style="text-align:center;">VALE DE SALIDA DE MATERIAL</h1>
        <hr>
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <p><strong>Fecha:</strong> <span id="f-fec"></span></p>
            <p><strong>Almacenista:</strong> <span id="f-alm"></span></p>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
            <p><strong>Recibe:</strong> <span id="f-rec"></span></p>
            <p><strong>Proyecto:</strong> <span id="f-pro"></span></p>
        </div>
        <table class="vale-table">
            <thead>
                <tr>
                    <th class="pzas-col">CANT.</th>
                    <th>MODELO</th>
                    <th>NO. PARTE</th>
                    <th>DESCRIPCI√ìN / NOMBRE</th>
                </tr>
            </thead>
            <tbody id="f-lista"></tbody>
        </table>
        <div style="margin-top:120px; display:flex; justify-content:space-around;">
            <p style="border-top:1px solid #000; width:220px; text-align:center; padding-top:5px;">Firma Almac√©n (Entrega)</p>
            <p style="border-top:1px solid #000; width:220px; text-align:center; padding-top:5px;">Firma Responsable (Recibe)</p>
        </div>
    </div>

    <script type="module">
        import { db, checkAuth } from './config.js';
        import { collection, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const user = checkAuth();
        const p = user.permisos || {};
        let productos = [];
        let carrito = [];

        window.cerrarSesion = () => {
            sessionStorage.clear();
            window.location.href = 'login.html';
        };

        const puedeHacerSalidas = (user.usuario === 'admin' || p.salidas);

        // Control de visibilidad de botones por permiso
        if(user.usuario === 'admin') {
            document.querySelectorAll('.side-menu button, .cart-box').forEach(el => {
                if(!el.classList.contains('btn-logout')) el.style.display = 'block';
            });
            document.getElementById('th-plus').style.display = 'table-cell';
        } else {
            if(p.registrar) document.getElementById('navReg').style.display = 'block';
            if(p.actualizar) document.getElementById('navAct').style.display = 'block';
            if(p.eliminar) document.getElementById('navEli').style.display = 'block';
            if(puedeHacerSalidas) {
                document.getElementById('cart-box').style.display = 'block';
                document.getElementById('th-plus').style.display = 'table-cell';
            }
        }

        onSnapshot(collection(db, "productos"), (snap) => {
            productos = [];
            snap.forEach(d => productos.push({...d.data(), id: d.id}));
            renderTable(productos);
        });

        function renderTable(lista) {
            const tbody = document.getElementById('inventory-body');
            tbody.innerHTML = '';
            lista.forEach(item => {
                const tr = document.createElement('tr');

                // L√ìGICA DE VISOR DE IMAGEN (Hover)
                tr.onmouseenter = () => {
                    const nombreParaFoto = (item.nombre || "sin_nombre").trim();
                    const imgPreview = document.getElementById('main-preview-img');
                    const titlePreview = document.getElementById('preview-title');
                    
                    imgPreview.src = `imagenes/${nombreParaFoto}.jpg`;
                    titlePreview.innerText = nombreParaFoto;
                    
                    imgPreview.onerror = () => { imgPreview.src = 'imagenes/sin_foto.jpg'; };
                };

                tr.innerHTML = `
                    <td style="display:${puedeHacerSalidas ? 'table-cell' : 'none'}">
                        <button class="btn-add-item" onclick="agregar('${item.id}')">Ôºã</button>
                    </td>
                    <td>${item.modelo || '-'}</td>
                    <td style="font-weight:bold; color:#0056b3;">${item.noParte || '-'}</td>
                    <td>${item.nombre || '-'}</td>
                    <td style="text-align:center;"><b>${item.cantidad || 0}</b></td>
                    <td>${item.ubicacion || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.agregar = (id) => {
            const prod = productos.find(x => x.id === id);
            const enCarro = carrito.find(x => x.id === id);
            if(enCarro) {
                if(enCarro.cOut + 1 > prod.cantidad) return alert("Sin stock suficiente");
                enCarro.cOut++;
            } else {
                if(prod.cantidad < 1) return alert("Sin existencias");
                carrito.push({...prod, cOut: 1});
            }
            dibujarCarrito();
        };

        function dibujarCarrito() {
            const box = document.getElementById('cart-list');
            box.innerHTML = carrito.length === 0 ? '<i>Vac√≠o</i>' : 
                carrito.map((item, i) => `
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:3px 0;">
                        <span style="font-size:11px;">${item.nombre} (<b>${item.cOut}</b>)</span>
                        <button onclick="carrito.splice(${i},1); dibujarCarrito();" style="border:none; color:red; background:none; cursor:pointer; font-weight:bold;">‚úï</button>
                    </div>
                `).join('');
        }

        window.procesarSalida = async () => {
            const r = document.getElementById('recep').value.trim();
            const py = document.getElementById('proyec').value.trim();
            if(!r || !py || carrito.length === 0) return alert("Faltan datos o productos");

            if(confirm("¬øConfirmar salida y generar vale?")) {
                try {
                    document.getElementById('f-fec').innerText = new Date().toLocaleDateString();
                    document.getElementById('f-alm').innerText = user.usuario;
                    document.getElementById('f-rec').innerText = r;
                    document.getElementById('f-pro').innerText = py;
                    
                    document.getElementById('f-lista').innerHTML = carrito.map(i => `
                        <tr>
                            <td class="pzas-col">${i.cOut} PZAS</td>
                            <td>${i.modelo || '-'}</td>
                            <td>${i.noParte || '-'}</td>
                            <td>${i.nombre}</td>
                        </tr>
                    `).join('');

                    for (const item of carrito) {
                        await updateDoc(doc(db, "productos", item.id), { cantidad: increment(-item.cOut) });
                    }

                    window.print();
                    carrito = []; dibujarCarrito();
                    document.getElementById('recep').value = ''; document.getElementById('proyec').value = '';
                } catch (e) { alert("Error al procesar"); }
            }
        };

        document.getElementById('mainSearch').oninput = (e) => {
            const t = e.target.value.toLowerCase();
            renderTable(productos.filter(p => 
                (p.nombre||'').toLowerCase().includes(t) || 
                (p.modelo||'').toLowerCase().includes(t) || 
                (p.noParte||'').toLowerCase().includes(t)
            ));
        };
    </script>
</body>
</html>